name: Build FFmpeg (Ubuntu24.04) & Push to kimycai/MP4BOX
# 仅手动触发，无任何自动执行规则
on:
  workflow_dispatch:

env:
  TARGET_REPO: kimycai/MP4BOX  # 你的目标仓库
  TARGET_BRANCH: main          # 推送到main分支
  # FFmpeg官方静态版下载地址（Ubuntu24.04 linux64，支持m4a/flac）
  FFMPEG_DOWNLOAD_URL: "https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-linux64-gpl.tar.xz"

jobs:
  fetch-ffmpeg-push:
    name: Fetch Static FFmpeg & Push to MP4BOX
    runs-on: ubuntu-24.04 # 原生Ubuntu24.04环境，与产物完全兼容
    steps:
      # 步骤1：配置Git全局身份（推送仓库必备，标准配置）
      - name: Configure Git Global Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤2：拉取你的kimycai/MP4BOX仓库（含.git目录，用于后续推送）
      - name: Checkout kimycai/MP4BOX Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ env.TARGET_BRANCH }}
          token: ${{ secrets.WRAPPER_PUSH_TOKEN }} # 复用你已配置的令牌
          path: MP4BOX # 相对路径，含完整.git仓库，无路径错误
          fetch-depth: 1 # 浅克隆提速，不影响推送

      # 步骤3：下载FFmpeg官方静态版（linux64，支持m4a→flac）
      - name: Download Official Static FFmpeg (Ubuntu24.04)
        run: |
          # 创建临时目录存放压缩包
          mkdir -p ffmpeg-tmp
          cd ffmpeg-tmp
          # 下载官方静态版压缩包（断点续传，避免下载失败）
          wget -c ${{ env.FFMPEG_DOWNLOAD_URL }} -O ffmpeg-linux64-static.tar.xz
          # 解压压缩包（仅提取ffmpeg可执行文件，无需其他文件）
          tar -xJf ffmpeg-linux64-static.tar.xz --strip-components=2 --wildcards "*/bin/ffmpeg"
          # 验证文件是否存在
          ls -lah ffmpeg && echo "✅ FFmpeg下载解压成功"

      # 步骤4：复制静态ffmpeg到MP4BOX仓库根目录+赋权
      - name: Copy FFmpeg to MP4BOX Repo & Add Exec Permission
        run: |
          # 复制可执行文件到仓库根目录
          cp ffmpeg-tmp/ffmpeg ./MP4BOX/
          # 双重赋予可执行权限（避免推送后权限丢失）
          chmod +x ./MP4BOX/ffmpeg
          # 验证1：确认是静态可执行文件（关键）
          file ./MP4BOX/ffmpeg | grep -q "statically linked" && echo "✅ 验证通过：纯静态版FFmpeg"
          # 验证2：确认支持m4a/flac编解码（核心需求）
          ./MP4BOX/ffmpeg -codecs | grep -E 'aac|flac' && echo "✅ 验证通过：支持m4a→flac转换"

      # 步骤5：提交并推送到kimycai/MP4BOX远程仓库
      - name: Commit & Push FFmpeg to Your Repository
        run: |
          cd ./MP4BOX # 进入正确的Git仓库目录（含.git）
          # 仅精准暂存ffmpeg文件，不影响仓库原有MP4Box等文件
          git add ./ffmpeg
          # 提交信息带时间戳，便于版本追溯
          git commit -m "Update FFmpeg (Ubuntu24.04 | linux64 | static | m4a→flac) - $(date +%Y%m%d_%H%M%S)" || echo "ℹ️ No changes to commit (FFmpeg is already the latest version)"
          # 推送到远程main分支（Action自动关联origin，无需手动配置）
          git push origin ${{ env.TARGET_BRANCH }}
